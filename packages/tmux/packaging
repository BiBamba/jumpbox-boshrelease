#!/bin/bash
set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Detect # of CPUs so make jobs can be parallelized
CPUS=$(grep -c ^processor /proc/cpuinfo)
 # Available variables
# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package
export HOME=/var/vcap

til() {
	rm -f /tmp/continue
	while ! test -f /tmp/continue; do
		sleep 1
	done
}

# Yes, this installs it locally, but that's OK
tar -xzvf tmux/libevent-2.0.22-stable.tar.gz
pushd libevent-2.0.22-stable
./configure --prefix=/usr --disable-shared
make -j${CPUS}
make install
popd

tar -xzvf tmux/tmux-2.2.tar.gz
pushd tmux-2.2
til
./configure --prefix=${BOSH_INSTALL_TARGET} \
            --enable-static
make -j${CPUS}
make install
touch ${BOSH_INSTALL_TARGET}/bin/.autoenv
popd
