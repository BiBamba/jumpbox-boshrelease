#!/bin/bash
exec </dev/null >>/var/vcap/sys/log/jumpbox.log 2>&1

log() {
  echo >&2 "[$(date +'%Y%m%d %HH%MM.%SS')] jumpbox/setup[$$]: " $*
}

set -e
rm -f /etc/profile.d/jumpbox.sh
cp /var/vcap/jobs/jumpbox/env /etc/profile.d/jumpbox.sh
source /etc/profile.d/jumpbox.sh
pidfile=/var/vcap/sys/run/jumpbox/watcher.pid
watcher=/var/vcap/jobs/jumpbox/bin/watcher

mkdir -p $(dirname $pidfile)
chown vcap:vcap $(dirname $pidfile)

case $1 in
  start)
    echo $$ > $pidfile
    exec $watcher
    ;;

  stop)
    kill -9 $(cat $pidfile)
    rm -f $pidfile
    ;;

  *)
    echo "Usage: jumpbox {start|stop}"
    ;;

esac
